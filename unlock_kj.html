<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width" name="viewport" />
<meta content="yes" name="apple-mobile-web-app-capable" />
<meta content="black" name="apple-mobile-web-app-status-bar-style" /> 
<meta content="telephone=no" name="format-detection" />
<title>邀约用户</title>
<link rel="shortcut icon" href="favicon.ico" />
<link rel="stylesheet" type="text/css" href="css/basic.css" />
<link rel="stylesheet" type="text/css" href="css/style.css?v=20180119" />
<style type="text/css">
.tongyifo{position:absolute;bottom:0;width:100%;display:-webkit-box;border-top:#f2f2f2 solid .02rem;background:#fff}
.tongyifo span{display:block;width:50%;-webkit-box-flex:1;line-height:.88rem;text-align:center;font-size:.32rem}
.tongyifo span.on{background:#1ebeb1;color:#fff}
.tc_sy .bxt2{font-size:.26rem}
.login_cn .cpxt .lab{min-width:1.3rem}
.may_sex #sex1,#sex2{-webkit-appearance:radio;vertical-align:-0.02rem;border:1px solid #000;width:.26rem;height:.26rem}
.may_sex label{margin-right:.4rem}
.login_cn .cpxt .fle{line-height:.86rem}
body .loadmore{color:#888;font-size:30px;line-height:100px;text-align:center;width:100%;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%)}
body .loadmore.loading::before{content:'';width:40px;height:40px;margin-top:-10px;margin-right:10px;display:inline-block;vertical-align:middle;animation:loading 1s steps(12) infinite;background:transparent url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PHBhdGggZmlsbD0ibm9uZSIgZD0iTTAgMGgxMDB2MTAwSDB6Ii8+PHJlY3Qgd2lkdGg9IjciIGhlaWdodD0iMjAiIHg9IjQ2LjUiIHk9IjQwIiBmaWxsPSIjRTlFOUU5IiByeD0iNSIgcnk9IjUiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAgLTMwKSIvPjxyZWN0IHdpZHRoPSI3IiBoZWlnaHQ9IjIwIiB4PSI0Ni41IiB5PSI0MCIgZmlsbD0iIzk4OTY5NyIgcng9IjUiIHJ5PSI1IiB0cmFuc2Zvcm09InJvdGF0ZSgzMCAxMDUuOTggNjUpIi8+PHJlY3Qgd2lkdGg9IjciIGhlaWdodD0iMjAiIHg9IjQ2LjUiIHk9IjQwIiBmaWxsPSIjOUI5OTlBIiByeD0iNSIgcnk9IjUiIHRyYW5zZm9ybT0icm90YXRlKDYwIDc1Ljk4IDY1KSIvPjxyZWN0IHdpZHRoPSI3IiBoZWlnaHQ9IjIwIiB4PSI0Ni41IiB5PSI0MCIgZmlsbD0iI0EzQTFBMiIgcng9IjUiIHJ5PSI1IiB0cmFuc2Zvcm09InJvdGF0ZSg5MCA2NSA2NSkiLz48cmVjdCB3aWR0aD0iNyIgaGVpZ2h0PSIyMCIgeD0iNDYuNSIgeT0iNDAiIGZpbGw9IiNBQkE5QUEiIHJ4PSI1IiByeT0iNSIgdHJhbnNmb3JtPSJyb3RhdGUoMTIwIDU4LjY2IDY1KSIvPjxyZWN0IHdpZHRoPSI3IiBoZWlnaHQ9IjIwIiB4PSI0Ni41IiB5PSI0MCIgZmlsbD0iI0IyQjJCMiIgcng9IjUiIHJ5PSI1IiB0cmFuc2Zvcm09InJvdGF0ZSgxNTAgNTQuMDIgNjUpIi8+PHJlY3Qgd2lkdGg9IjciIGhlaWdodD0iMjAiIHg9IjQ2LjUiIHk9IjQwIiBmaWxsPSIjQkFCOEI5IiByeD0iNSIgcnk9IjUiIHRyYW5zZm9ybT0icm90YXRlKDE4MCA1MCA2NSkiLz48cmVjdCB3aWR0aD0iNyIgaGVpZ2h0PSIyMCIgeD0iNDYuNSIgeT0iNDAiIGZpbGw9IiNDMkMwQzEiIHJ4PSI1IiByeT0iNSIgdHJhbnNmb3JtPSJyb3RhdGUoLTE1MCA0NS45OCA2NSkiLz48cmVjdCB3aWR0aD0iNyIgaGVpZ2h0PSIyMCIgeD0iNDYuNSIgeT0iNDAiIGZpbGw9IiNDQkNCQ0IiIHJ4PSI1IiByeT0iNSIgdHJhbnNmb3JtPSJyb3RhdGUoLTEyMCA0MS4zNCA2NSkiLz48cmVjdCB3aWR0aD0iNyIgaGVpZ2h0PSIyMCIgeD0iNDYuNSIgeT0iNDAiIGZpbGw9IiNEMkQyRDIiIHJ4PSI1IiByeT0iNSIgdHJhbnNmb3JtPSJyb3RhdGUoLTkwIDM1IDY1KSIvPjxyZWN0IHdpZHRoPSI3IiBoZWlnaHQ9IjIwIiB4PSI0Ni41IiB5PSI0MCIgZmlsbD0iI0RBREFEQSIgcng9IjUiIHJ5PSI1IiB0cmFuc2Zvcm09InJvdGF0ZSgtNjAgMjQuMDIgNjUpIi8+PHJlY3Qgd2lkdGg9IjciIGhlaWdodD0iMjAiIHg9IjQ2LjUiIHk9IjQwIiBmaWxsPSIjRTJFMkUyIiByeD0iNSIgcnk9IjUiIHRyYW5zZm9ybT0icm90YXRlKC0zMCAtNS45OCA2NSkiLz48L3N2Zz4=) no-repeat;background-size:100%}
@keyframes loading{from{transform:rotate(0deg)}
to{transform:rotate(-360deg)}
}body .loadmore.loading.lll{position:relative;top:1rem;left:45%;font-size:18px}
body .loadmore{display:block}
.my_view{display:none}
.intyzm{ display: inline-block; height: .86rem; vertical-align: top; width: 50%; font-size: .3rem;}
.sendyzm{ display: inline-block; vertical-align: top; width: 49.5%; font-size: .3rem; text-align: center; background: rgba(46, 186, 177,0.5); color: #ffffff; border-radius: .08rem; line-height: .86rem;}
button.off{ background: #cccccc;}
</style>
</head>
<body class="bck-col-fff">
<div class="loadmore loading"></div>
<section class="my_view" id="vmapp">
<header class="header">
	<!--<a class="t-left fl goToPer" @click="godayin()" v-if="!clientType">下载报告</a>-->
	<a class="t-right fr" @click="gohistory()"><i class="i_c"><img src="img/i-his.png"></i>邀约历史</a>
	<!--<p class="t-cen"><span>{{inspectDate}}</span></p>-->
</header>
<div class=""><img src="img/login_t.jpg" class="img_b"></div>
<div class="d_login">
	<div class="login_cn">
		<p class="ctit">欢迎来到康加</p>
		<p class="cpxt">
        <span class="lab">姓名</span><!--姓名-->
        <span class="fle"><input type="text" id="userName" placeholder="请输入姓名" v-model="userData.userName"></span>
      </p>
    <p class="cpxt">
        <span class="lab">电话</span><!--电话-->
        <span class="fle"><input type="number" id="mobile" placeholder="请输入手机号码" v-model="userData.userTel" pattern="[0-9]*" oninput="if(value.length>11)value=value.slice(0,11)"></span>
      </p>
    <div class="cpxt" style="font-size: 0;">
        <span class="lab">验证码</span><!--电话-->
        <div class="fle">
        	<span class="intyzm"><input type="number" placeholder="输入验证码" v-model="code"></span>
        	<button class="sendyzm" @click="sendyzm($event)">发送验证码</button>
        </div>
    </div>
    <p class="cpxt may_sex">
			<span class="lab">性别</span><!--性别-->
			<span class="fle">
				<input type="radio" id="sex1" name="sex" value="1" v-model="userData.gender"><label for="sex1"> 男</label> 
				<input type="radio" id="sex2" name="sex" value="2" v-model="userData.gender"><label for="sex2"> 女</label>
			</span>
    </p>
    <p class="cpxt reportType120" >
			<span class="lab">身高</span><!--身高-->
			<span class="fle"><input type="number" id="height" v-model="userData.height" placeholder="请输入身高(厘米cm)"   pattern="[0-9]*" onkeyup="value=value.replace(/^(0+)|[^\d]+/g,'')"></span>
    </p>
    <p class="cpxt reportType120" >
			<span class="lab">体重</span><!--体重-->
			<span class="fle"><input type="number" id="weight" v-model="userData.weight" placeholder="请输入体重(千克kg)"   pattern="[0-9]*" onkeyup="value=value.replace(/^(0+)|[^\d]+/g,'')"></span>
    </p>
    <p class="cpxt reportType120" >
			<span class="lab">年龄</span><!--年龄-->
			<span class="fle"><input type="number" id="age" v-model="userData.age" placeholder="请填写真实年龄(18岁-110岁)"   pattern="[0-9]*"></span>
	</p>
	<div class="" style="padding: .3rem 0 0; height: .4rem; line-height: .4rem;">
		<input type="checkbox" style="width: .3rem; height: .3rem; vertical-align: top; -webkit-appearance: checkbox; position: relative; top: .05rem;" >
		<a href="./notice_ysxy.html">《用户隐私协议》</a>
	</div>
	<p class="cbtn"><button id="yaoyue_kj"  @click="soSub()" style="background: #2ebab1;">确定</button></p>
	
	<div style="color: #FF8866; font-size: .24rem; line-height: .32rem; margin-top: .2rem;">邀约检测频繁会遇到公众号消息限制，收不到报告消息，需要向公众号发送消息 或点击公众号菜单进行恢复。</div>
	</div>
	
</div>
</section>
<div class="tc-qx" id="alert">
  <p class="pc1">请完善用户信息</p>
  <p class="psub"><a class="subBtn">确定</a></p>
</div>
<div class="modal-overlay"></div>

<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/base.js"></script>
<!-- <script type="text/javascript" src="zhuge.js"></script> -->
<script>document.write('<script src="zhuge.js?t=' + new Date().getTime() + '"><\/script>')</script>
<script type="text/javascript" src="js/vue.min.js"></script>
<script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
<script type="text/javascript">
(function (doc, win) {
    var docEl = doc.documentElement,
        resizeEvt = 'orientationchange' in window ? 'orientationchange' : 'resize',
        recalc = function () {
            var clientWidth = docEl.clientWidth;
            if (!clientWidth) return;
            if(clientWidth>=750){
                docEl.style.fontSize = '100px';
            }else{
                docEl.style.fontSize = 100 * (clientWidth / 750) + 'px';
            }
        };
    if (!doc.addEventListener) return;
    win.addEventListener(resizeEvt, recalc, false);
    doc.addEventListener('DOMContentLoaded', recalc, false);
})(document, window);
</script>
<script>
var openId = getQueryString('openId');
var wait=60;
var app = new Vue({
	el:'#vmapp',
	data:function(){
		return{
			openId: openId,
			userData:{
				userName:'',
				age:'',
				userTel:'',
				gender:'',
				height:'',
				weight:'',
				inviterId: openId,
				qrUrl:'',
				code:''
			},
			code:''
		}
	},
	methods:{
		sendyzm: function(e){
			var vm = this;
			if(!(/^1[3456789]\d{9}$/.test(vm.userData.userTel))){ 
				alert('请输入正确的手机号码');
				return false;
			}else{
				time($(e.target))
				vm.getCode()
			}
				
		},
		getCode: function(){
			var vm = this;
			$.ajax({
				type:"post",
				url:dataUrl + "/api/v1/messageCode/getCode",
				dataType : 'json',
		        data : {
		        	userId: vm.userData.userTel
		        },
		        success: function(res){
		        	if(res.code == 200){
						vm.kjSendMsg(res.data);
					}else{
						alert('获取短信码失败 getCode code='+codeData.code);
					}	
		        }
			});
		},
		kjSendMsg: function(code){ //发送短信
			var vm = this;
			$.ajax({
				type:"post",
				url:dataUrl + "/api/v1/messageCode/kjSendMsg",
				dataType:'Json',
				data:{
					mobile : vm.userData.userTel,
					code : code,
					userId : vm.userData.userTel
				},
				success:function(res){console.log('发送短信')},
				error:function(){console.log('kjSendMsg error')}

			});
		},
		soSub: function(){
			var vm = this
			console.log(vm.userData);
	      	if(vm.userData.userName == '' || vm.userData.gender == ''){ 
	        	showMask('请填写完整信息')
	      	}else{
	      		if(!(/^1[3456789]\d{9}$/.test(vm.userData.userTel))){ 
			      	showMask('请输入正确的手机号码');
			      	return false;
			    };
			    if(vm.userData.height =='' || parseFloat(vm.userData.height)>250 || parseInt(vm.userData.height)<50){
			      	showMask('请输入正确的身高');
			      	return false;
			    };
			    if(vm.userData.weight == ''|| parseFloat(vm.userData.weight)>200 || parseInt(vm.userData.weight)<20){
			      	showMask('请输入正确的体重');
			      	return false;
			    };
			    if(vm.userData.age == '' || parseFloat(vm.userData.age) < 18 || parseFloat(vm.userData.age) >110){
					showMask('请输入18到110之间的有效年龄');
		      		return false;
				}
	      		console.log('jin sao ma')
		      	wx.ready(function() {
		          	wx.scanQRCode({
				        needResult : 1, // 默认为0，扫描结果由微信处理，1则直接返回扫描结果，
		            	scanType : [ "qrCode"], // 可以指定扫二维码还是一维码，默认二者都有
		            	success : function(res) {
		              		vm.userData.qrUrl = res.resultStr
		              		vm.sendP();
		            	}
		          	})
				});
	      	}
		},
		sendP: function(){
			var vm = this
			$.ajax({
		      url: dataUrl+'/api/v1/neUnLock/invite?code='+vm.code,
		      type:'POST',
		      contentType : 'application/json',
		      dataType : 'json',
		      data:JSON.stringify(vm.userData),
		      success:function(res){
		        if(res.code == 400){
		          showMask(res.msg)
		        }else if(res.code == 200){
		          WeixinJSBridge.call('closeWindow');
		        }else{
		        	showMask(res.msg+' code='+res.code)
		        }
		      },
		      error:function(err){
		      }
		    })
		},
		gohistory:function(){
			var vm = this
			location.href = "historyRecord.html?openId="+openId+'&invite='+'invite'
		},
		wxConfig: function(){
			$.ajax({
		      type:"post",
		      url: dataUrl+ "/weiXin/wxConfig",
		      data:{
		        reqUrl: window.location.href
		      },
		      success:function(result){
		          $('.loadmore').css('display','none')
		          $('.my_view').css('display','block')
		          flag = true
		          wx.config({
		            // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
		            debug: false,
		            // 必填，公众号的唯一标识
		            appId: result.wxParameter.appId,
		            // 必填，生成签名的时间戳
		            timestamp:""+result.wxParameter.timestamp,
		            // 必填，生成签名的随机串
		            nonceStr:result.wxParameter.nonceStr,
		             // 必填，签名，见附录1
		             signature:result.wxParameter.signature,
					       // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
					       jsApiList : [ 'checkJsApi', 'scanQRCode' ]
		           });
		          },
		          error:function(){
		            location.reload() 
		          }
			});
			wx.error(function(res) {
	          flag = false
	          alert("出错了：" + res.errMsg);//这个地方的好处就是wx.config配置错误，会弹出窗口哪里错误，然后根据微信文档查询即可。
			});
		}
	},
	mounted:function(){
		this.wxConfig()
	}
});

$('userName,#height,#mobile,#weight,#age').blur(function(){
    setTimeout(function() {	
  		var scrollHeight = document.documentElement.scrollTop || document.body.scrollTop || 0;  //解决微信浏览器键盘收回页面下不来的问题
        window.scrollTo(0, Math.max(scrollHeight - 1, 0));  //解决微信浏览器键盘收回页面下不来的问题
    }, 100);
});
//截取URL 获取
function getQueryString(name){
     var result = window.location.search.match(new RegExp("[\?\&]" + name + "=([^\&]+)", "i"));
    if (result == null || result.length < 1) {
        return "";
    }
    return result[1];
};
  
//倒计时读秒    默认wait=60;
function time(tm){
	if(wait==0){
		tm.attr("disabled",false);
		tm.text('获取验证码');
		wait=60;
		tm.removeClass('off')
	}else{
		tm.addClass('off')
		tm.attr("disabled",true);
		tm.text(wait + "秒后重新发送")
		wait--;
		setTimeout(function(){time(tm);},1000);
	}
};

const windowHeightSize = String(document.documentElement.clientHeight || document.body.clientHeight );
if (!(localStorage.getItem('windowHeight'))) {
  localStorage.setItem('windowHeight' , windowHeightSize);
}
const historyWindowHeight = Number(localStorage.getItem('windowHeight'));
console.log('缓存 列表最小高度' + historyWindowHeight);
$('body').css('min-height', historyWindowHeight);

//弹窗 模拟alert
function showMask(msg){
	$('body').css("min-height",historyWindowHeight);
	setTimeout(function(){
		$('.tc-qx').each(function(){
			var w_height = $(window).height();
			var this_height = $(this).height();
			$(this).css("top",(w_height-this_height)/2);
		});
		$('.modal-overlay').css({"visibility":"visible","opacity":"1"});
		$('#alert').css({"visibility":"visible","opacity":"1"});
		$('#alert .pc1').empty().text(msg);
		$('#alert .subBtn').click(function(){closeMask()});
	},20)
	
}//showMask('哈哈哈哈');
function closeMask(){
	$('body').css({"position":"static"});
	$('.modal-overlay').css({"visibility":"hidden","opacity":"0"});
	$('.tc-qx').css({"visibility":"hidden","opacity":"0"});
}

</script>
<script>
(function () {
    if (typeof WeixinJSBridge == "object" && typeof WeixinJSBridge.invoke == "function") {
        handleFontSize();
    } else {
        if (document.addEventListener) {
            document.addEventListener("WeixinJSBridgeReady", handleFontSize, false);
        } else if (document.attachEvent) {
            document.attachEvent("WeixinJSBridgeReady", handleFontSize);
            document.attachEvent("onWeixinJSBridgeReady", handleFontSize);
        }
    }
    function handleFontSize() {
        WeixinJSBridge.invoke('setFontSizeCallback', { 'fontSize': 0 });
        WeixinJSBridge.on('menu:setfont', function () {
            WeixinJSBridge.invoke('setFontSizeCallback', { 'fontSize': 0 });
        });
    }
})();	
</script>
</body>
</html>
