<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width" name="viewport" />
<meta content="yes" name="apple-mobile-web-app-capable" />
<meta content="black" name="apple-mobile-web-app-status-bar-style" /> 
<meta content="telephone=no" name="format-detection" />
<title>支付</title>
<link rel="stylesheet" type="text/css" href="css/basic.css" />
<link rel="stylesheet" type="text/css" href="css/style.css" />
</head>
<body>
<div class="my_view bck-col-f4">
<section id="appVUE">
	<header class="header">
		<a class="b-arr fl" href="javascript:history.go(-1);"></a>
		<a class="t-right fr" href="#"></a>
		<p class="t-cen txt1"><span>{{payTypeName}}</span></p>
	</header>
	<div class="d-wxpay">
		<div class="wxpay">
			<div class="dtit"><i class=""></i><span class="">订单已提交成功，请您尽快付款</span></div>
			<p class="p1"><span>订单名称：</span><font>{{name}}</font></p>
			<p class="p1"><span>订单金额：</span><font>{{price}}</font>元套餐</p>
		</div>
		<p class="xiaoji"><span><em id="xgj">共计</em>：￥</span><font>{{price}}</font></p>
	</div>
	
	<div class="d-wxpay" id="usecoupon" style="display: none;">
		<p class="coutit">使用优惠券</p>
		<div class="wxpay">
			<p class="coupon on"><i class="check"></i><span>使用优惠券</span><em id="discount" class="fr">-￥{{discount}}</em></p>
		</div>
		<p class="xiaoji" style="line-height: 1rem;"><span>共计：￥</span><font id="subprice">{{subprice}}</font></p>
	</div>
	<p style="padding: 0 .3rem; font-size: .24rem;">注：请您在48小时内付款，超出48小时后此报告将无法查看</p>
	
	<div class="subpay"><button class="btn_pay" id="goWxPay" @click="gotoPay($event)">支付</button></div>
</section>
</div>

<!--一网通请求-->
<form action="" method="post" id="ywt">
    <input id="ywtVal" type="hidden" name="jsonRequestData" value='' />
</form>

<script type="text/javascript" src="js/jquery.js"></script>
<script>document.write('<script src="js/base.js?t=' + new Date().getTime() + '"><\/script>')</script>
<script type="text/javascript" src="js/vue.min.js"></script>
<script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script type="text/javascript">
(function (doc, win) {
    var docEl = doc.documentElement,
        resizeEvt = 'orientationchange' in window ? 'orientationchange' : 'resize',
        recalc = function () {
            var clientWidth = docEl.clientWidth;
            if (!clientWidth) return;
            if(clientWidth>=750){
                docEl.style.fontSize = '100px';
            }else{
                docEl.style.fontSize = 100 * (clientWidth / 750) + 'px';
            }
        };
    if (!doc.addEventListener) return;
    win.addEventListener(resizeEvt, recalc, false);
    doc.addEventListener('DOMContentLoaded', recalc, false);
})(document, window);
</script>
<script>
//截取URL 获取
function getQueryString(name){
     var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
     var r = window.location.search.substr(1).match(reg);
     if(r!=null)return  unescape(r[2]); return null;
};
var saasId=getQueryString("saasId");
var reportId=getQueryString("reportId");
var reportType=getQueryString("reportType"); //版本 新
var packageId=getQueryString("packageId");
var userId=getQueryString("userId");
var openId=getQueryString("openId");
var orderNum=getQueryString("orderNum");
var payChannelId=getQueryString("payChannelId");
var payChannelType=getQueryString("payChannelType");  //1微信 7招行一网通
if(payChannelType == 1){
	var payTypeName = '微信支付'
}else if(payChannelType == 7){
	var payTypeName = '一网通支付'
}else{
	var payTypeName = '支付'
};
var tp=getQueryString("tp");  //判断kj201
var voucherId = 0;
var discount = 0; //优惠

var myurl = window.location;
var useurl = decodeURI(myurl);
var start =useurl.indexOf('name=');
var stop =useurl.indexOf('&',start);
var myname = useurl.substring(start+5,stop);
var myprice=getQueryString("price");
var myApp = new Vue({
  	el: '#appVUE',
  	data: function(){
  		return{
  			saasId:saasId,
  			reportId: reportId,
  			reportType: reportType,
  			openId: openId,
  			userId: userId,
  			packageId: packageId,
  			orderNum: orderNum,
  			payChannelId: payChannelId,
  			payChannelType: payChannelType,
	  		name: myname, 
		    price: myprice,
		    payTypeName: payTypeName,
			discount: 0,
			voucherId: 0,
			subprice: myprice,
  		}
  	},
  	methods:{
  		isUsableByCustomerIdAndNeId: function(){ //判断优惠卷是否可用,返回有效期最短的优惠券
  			var vm = this;
  			$.ajax({
				url : couponData + "/v1/use/coupon/isUsableByCustomerIdAndNeId",
			    type : "POST",
				dataType : 'json',
				data : {
				    inspectCode : reportId, //报告IDl
				    customerId : userId
				},
				success: function(data){
					if(data.data == null || data.data == ''){
						$('#usecoupon').css("display","none");
					}else{
						$('#xgj').text('小计');
						$('#usecoupon').css("display","block");
						if(data.data.discountType == 1){
							vm.discount = data.data.discountNum;
						}else if(data.data.discountType == 2){
							vm.discount = myprice-(myprice*data.data.discountNum)
						};
						vm.voucherId = data.data.voucherId;
						vm.subprice = (myprice-vm.discount).toFixed(2);
					};
				},
				error: function(){console.log('isUsableByCustomerIdAndNeId error')}
			});
  		},
  		//更新SaaS用户最近一份报告ID
  		updateCustomerSaas: function(){
  			var vm = this;
  			$.ajax({
  				type:"post",
  				url: dataUrl+"/api/v1/ne/updateCustomerSaas",
  				dataType : 'json',
  				data:{
  					saasId: saasId,
  					openId: openId,
  					reportId: reportId
  				},
  				success: function(res){
  					vm.goReport();
  					console.log(res);
  					//alert('updateCustomerSaas success')
  				},
  				error: function(){
  					alert('updateCustomerSaas error');
  					vm.goReport();
  				}
  			});
  		},
  		
  		gotoPay: function(e){ //点击支付
  			var vm = this;
			$(e.target).attr("disabled",true);//新加防呆
			$.ajax({
			    url:channel + "/pay/v1/channel/payOrder",
			    type : "POST",
				dataType : 'json',
				data : {
				    attach : openId, 
				    orderNum : orderNum,
				    payChannelId : payChannelId,
				    payPrice : vm.subprice,
				    userId : userId,
				    voucherId: voucherId
				},
			    success : function(result) {
			    	if(result.code == 0){
			    		if(payChannelType == 1){ //weixin
				    		if(result.code == 0) {
					            WeixinJSBridge.invoke('getBrandWCPayRequest',{  
					                "appId" : result.result.appId,              //公众号名称，由商户传入  
					                "timeStamp": result.result.timeStamp,       //时间戳，自 1970 年以来的秒数  
					                "nonceStr" : result.result.nonceStr,        //随机串  
					                "package" : result.result.package,          //商品包信息 
					                "signType" : result.result.signType,       //微信签名方式
					                "paySign" : result.result.sign            //微信签名  
					                },function(res){
					                	//debugger;
					                    if(res.err_msg == "get_brand_wcpay_request:ok" ) { //支付成功
					                    	//alert('支付成功测试');
					                    	vm.updateCustomerSaas();
			
					                    }else if (res.err_msg == "get_brand_wcpay_request:cancel") {
											alert("支付取消");
											$('#goWxPay').attr("disabled",false);  //新加防呆
										}else if (res.err_msg == "get_brand_wcpay_request:fail") {
											alert("支付失败："+res.err_desc);
											$('.wxpay .dtit i').addClass('fail');
											$('.wxpay .dtit span').html('支付失败');
											$('#goWxPay').attr("disabled",false);  //新加防呆
										}
					                }
					            ); 
					        }else{
					            alert(result.msg);
					            $('#goWxPay').attr("disabled",false);  //新加防呆
					        }
				    	///////////
				    	}else if(payChannelType == 7){ //yiwangtong
				    		if(result.code ==0){
				    			//一网通支付操作
				    			var form = document.getElementById('ywt');
				    			form.action = result.url;
				    			var _val = result.result;
				    			$('#ywtVal').val(_val);
				    			form.submit();
				    		}else{
				    			alert(result.msg);
				    		}
				    	//////////
				    	}else if(payChannelType == 12){ //微信-H5 支付
				    		if(result.code ==0){
				    			window.location.href = result.mweb_url
				    		}else{
				    			alert(result.msg);
				    		}
				    	}else if(payChannelType == 8){  //天津农商行
				    		location.href = result.result
				    	}
			    	}else{
			    		alert('payOrder code='+result.code+result.msg)
			    	}
				    	
			    },
			    error: function(){alert('payOrder error');$('#goWxPay').attr("disabled",false);}
			});	
  		},
  		findPackage: function(){ //再次进去页面判断调取接口判断报告是否是已经支付
  			var vm = this;
			$.ajax({
				url : dataUrl + "/api/v1/reportWxPay/findPackage",
			    type : "POST",
				dataType : 'json',
				data : {
				    reportId : reportId, 
				    openId : openId
				},
				success: function(data){
					if(data.code == 200){
						if(reportType == 121){
							location.href='report120.html?reportId='+reportId+'&userId='+userId+'&reportType='+reportType+'&openId='+openId+'&saasId='+saasId
						}else if(reportType == 501){
							location.href='report500.html?reportId='+reportId+'&userId='+userId+'&reportType='+reportType+'&openId='+openId+'&saasId='+saasId
						}else{
							location.href='report'+reportType+'.html?reportId='+reportId+'&userId='+userId+'&reportType='+reportType+'&openId='+openId+'&saasId='+saasId
						}
					}
				}
			});
  		},
  		//跳转报告逻辑
  		goReport: function(){
  			if(tp == 201){
        		window.location.href=bit_testHealthUrl + "/index.html?reportId="+reportId + '&openId=' + openId+'&saasId='+saasId;
        	}else{
        		if(reportType == 121){
					location.href='report120.html?reportId='+reportId+'&userId='+userId+'&reportType='+reportType+'&openId='+openId+'&saasId='+saasId
				}else if(reportType == 501){
					location.href='report500.html?reportId='+reportId+'&userId='+userId+'&reportType='+reportType+'&openId='+openId+'&saasId='+saasId
				}else{
					location.href='report'+reportType+'.html?reportId='+reportId+'&userId='+userId+'&reportType='+reportType+'&openId='+openId+'&saasId='+saasId
				}
        	}
  		},
  		
  	},
  	mounted:function(){
  		this.findPackage();
  		this.isUsableByCustomerIdAndNeId();
  		//this.updateCustomerSaas();
  	}
});
</script>


</body>
</html>
