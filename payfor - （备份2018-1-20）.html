<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width" name="viewport" />
<meta content="yes" name="apple-mobile-web-app-capable" />
<meta content="black" name="apple-mobile-web-app-status-bar-style" /> 
<meta content="telephone=no" name="format-detection" />
<title>支付</title>
<link rel="stylesheet" type="text/css" href="css/basic.css" />
<link rel="stylesheet" type="text/css" href="css/style.css?t=201801208" />
</head>
<body>
<div class="my_view" id="appVUE" style="background: #f4faf9; height: auto; padding-bottom: .88rem;">
	<!--<header class="header">
		<a class="b-arr fl" href="javascript:history.go(-2);"></a>
		<a class="t-right fr" href="#"></a>
		<p class="t-cen txt1"><span>支付</span></p>
	</header>-->
	
	<div class="pay_x_bg">
		<p class="btit"><i class="ico"></i><span class="lab">报告分值</span></p>
		<div class="bcon">
			<div class="cn_l">
				<p class="nikimg"><img :src="headimgurl"></p>
				<p class="nikname">{{nickName}}</p>
			</div>
			<div class="cn_r">
				<p class="p1"><font>{{totalScore}}</font>分  <span class="ranking">好于<em>{{ranking}}%</em>的人</span></p>
				<p class="rpcn"><i class="ic"></i>您的生理年龄是<em>{{age}}</em>岁</p>
			</div>
		</div>
	</div>
	<div class="healthSta">您的身体处于<span class="sta">{{ps}}</span></div>
	
	<div class="pay_x_cn">
		<p class="btit"><i class="ico"></i><span class="lab">关注事项</span></p>
		<div class="xcon">
			<p class="ptit"><em class="dian"></em>您有 <font>2</font> 项系统得分偏低</p>
			<ul class="ablist">
				<li v-for="site in firstNames">
					<p class="itimg"><img src=""></p>
					<p class="nam">{{site}}</p>
				</li>
			</ul>
			<p class="ptit"><em class="dian"></em>您有 <font>{{abnormalNo}}</font> 个异常指标</p>
			<p class="ptit"><em class="kong"></em>其中 <font>{{litAbnormal}}</font> 个轻度异常指标</p>
		</div>
	</div>
	<p class="pay_x_tip">支付即可查看详细指标及知名专家提供的改善方案 (<font>膳食、营养素、运动</font>)</p>
	
	<div class="pay-x-fix">
		<button class="pay" id="pay">支 付</button>
		<span class="price">优惠价:<font>￥{{price}}</font></span>
		<span class="oprice">原价:<font>￥{{oprice}}</font></span>
	</div>

	<div class="sl-pay">
		<p class="bt"><span>选择支付方式</span><i class="close"><img src="img/o-close.png"></i></p>
		<div class="cnn">
			<p class="p1">支付金额</p>
			<p class="p2">￥{{price}}</p>
		</div>
		<a class="pay-li" id="WordPay"><i class="ico"><img src="img/o-key.png"></i><span>口令支付</span><img class="arr" src="img/o-arr.png"></a>
		<a class="pay-li" id="wxpay"><i class="ico"><img src="img/o-wx.png"></i><span id="wxPay">微信支付</span><img class="arr" src="img/o-arr.png"></a>
		<a class="pay-li" id="kaPay"><i class="ico"><img src="img/o-key.png"></i><span>卡支付</span><img class="arr" src="img/o-arr.png"></a>
	</div>	

</div>

<div class="v_overlay"></div>
<div class="load-overlay">
	<div class="loadimg"><img src="img/loading.gif"></div>
</div>

<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/base.js"></script>
<script type="text/javascript" src="js/vue.min.js"></script>

<script type="text/javascript">
(function (doc, win) {
    var docEl = doc.documentElement,
        resizeEvt = 'orientationchange' in window ? 'orientationchange' : 'resize',
        recalc = function () {
            var clientWidth = docEl.clientWidth;
            if (!clientWidth) return;
            if(clientWidth>=750){
                docEl.style.fontSize = '100px';
            }else{
                docEl.style.fontSize = 100 * (clientWidth / 750) + 'px';
            }
        };

    if (!doc.addEventListener) return;
    win.addEventListener(resizeEvt, recalc, false);
    doc.addEventListener('DOMContentLoaded', recalc, false);
})(document, window);
</script>

<script>
$('.my_view').css("display","none");
$('.load-overlay').css("display","block");
//截取URL 获取
function GetQueryString(name){
     var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
     var r = window.location.search.substr(1).match(reg);
     if(r!=null)return  unescape(r[2]); return null;
};
var myreportId=GetQueryString("reportId");
var myopenId=GetQueryString("openId");
var isShowCard=GetQueryString("sameUser");

$.ajax({
url : dataUrl + "/api/v1/reportWxPay/findPackage",
type : "post",
dataType : 'json',
data : {
    reportId : myreportId,
    openId : myopenId
},
success : function(indexData) {
	//alert('get it')
	if(indexData.code==200){
		window.location.href="index.html?reportId="+myreportId+"&openId=" + myopenId;
	}else if(indexData.code==201){
		$('.my_view').css("display","block");
		$('.load-overlay').css("display","none");
 		var myApp = new Vue({
			el: '#appVUE',
			data: {
			  	nickName: indexData.data.mentPage.nickName, //昵称
			  	headimgurl: indexData.data.mentPage.headimgurl, //头像
			  	totalScore: indexData.data.mentPage.totalScore, //总分
			  	age: indexData.data.mentPage.age, //生理年龄
			  	ranking: indexData.data.mentPage.ranking, //排名
			  	ps: indexData.data.mentPage.ps, //身体状况
			  	name: indexData.data.infoView.name, //套餐名称
			  	price: indexData.data.infoView.price,  //价格
			  	//oprice: indexData.data.infoView.price+20, //原价
			  	oprice: indexData.data.infoView.originalPrice, //原价
			  	description: indexData.data.infoView.description,  //描述
			  	abnormalNo: indexData.data.mentPage.abnormal.list4.length+indexData.data.mentPage.abnormal.list3.length+indexData.data.mentPage.abnormal.list2.length, //全部异常项目数
			  	litAbnormal: indexData.data.mentPage.abnormal.list2.length,
			  	firstNames: indexData.data.mentPage.firstNames  //得分最低两个系统名字
			}
		});
		//判断生理年龄和排名没有的情况
		var ranking = indexData.data.mentPage.ranking; //排名
		var age = indexData.data.mentPage.age; //生理年龄
		if(ranking == 0 || ranking == null || ranking == ''){
			$('.ranking').css("display","none");
		};
		if(age == 0 || age == null || age == ''){
			$('.rpcn').css("display","none");
			$('.pay_x_bg .bcon .cn_r .p1').css("padding-left",".6rem");
		};
		//判断原价为0的时候  设现价+20
		var originalPrice = indexData.data.infoView.originalPrice; // 原价
		if(originalPrice == '' || originalPrice == null){
			$('.pay-x-fix .oprice font').html('￥'+ (indexData.data.infoView.price + 20));
		};
		//获取图标
		$('.pay_x_cn .ablist li .nam').each(function(index){
			if($(this).text() == '循环系统'){
				$(this).prev('p').find('img').attr("src","img/pay-x-i-xunhuan.png");
			}else if($(this).text() == '消化系统'){
				$(this).prev('p').find('img').attr("src","img/pay-x-i-xiaohua.png");
			}else if($(this).text() == '呼吸系统'){
				$(this).prev('p').find('img').attr("src","img/pay-x-i-huxi.png");
			}else if($(this).text() == '内分泌'){
				$(this).prev('p').find('img').attr("src","img/pay-x-i-neifenmi.png");
			}else if($(this).text() == '骨骼系统'){
				$(this).prev('p').find('img').attr("src","img/pay-x-i-guge.png");
			}else if($(this).text() == '免疫系统'){
				$(this).prev('p').find('img').attr("src","img/pay-x-i-mianyi.png");
			}else if($(this).text() == '生殖系统'){
				$(this).prev('p').find('img').attr("src","img/pay-x-i-shengzhi.png");
			}else if($(this).text() == '营养状态'){
				$(this).prev('p').find('img').attr("src","img/pay-x-i-yingyang.png");
			}else{
				$(this).prev('p').find('img').attr("src","img/pay-x-i-youdu.png");
			}
		});
		//判断新用户
		var isFree = indexData.data.infoView.isFree;
		if(isFree == 1){
			$('.pay-x-fix .oprice').html('新用户首次免费');
			$('#pay').html('查看');
			$('#pay').click(function(){
				window.location.href="index.html?reportId="+myreportId+"&openId=" + myopenId;
			});
		};
		var userId = indexData.data.infoView.userId;
		var packageId = indexData.data.infoView.packageId;
		var name = indexData.data.infoView.name;
		var price = indexData.data.infoView.price;
		
		if(price == 0){
			$('#pay').on("click",function(){
				$.ajax({
					url : dataUrl + "/api/v1/reportWxPay/insertFreeOrder",
					type : "post",
					dataType : 'json',
					data : {
					    reportId : myreportId,
					    packageId: packageId,
					    userId: userId
					},
					success : function(data) {
						window.location.href="index.html?reportId="+myreportId+"&openId=" + myopenId;
					}
				})
			});
		}else{
			$('#pay').on("click",function(){
				//判断isShowCard (是否是本人的报告), 1/2 是否显示卡支付
				if(isShowCard == 2){
					$('#kaPay').css("display","none");
				}else{
					//判断用户有没有可用卡
					$.ajax({
						url : dataUrl + "/api/v1/cardPay/findUserCards",
						type : "POST",
						dataType : 'json',
						data : {
							reportId : myreportId,
						   	userId : userId
						},
						success : function(data) {
							//alert('查找用户可用卡');
							if(data.code == 200){
								var cards = data.data.List;
								if(cards == null || cards.length == 0 || cards == ''){
									$('#kaPay').css("display","none");
								};
							}else{
								alert('查找用户可用支付卡 code= '+ data.code)
							}
						}
					});
				};
				//选择支付方式
				$('.v_overlay').css({"visibility":"visible","opacity":"1"});
				$('.sl-pay').css({"transform":"translateY(0%)"});
			});
		};

		//关闭 选择方式
		$('.close').click(function(){
			$('.v_overlay').css({"visibility":"hidden","opacity":"0"});
			$('.sl-pay').css({"transform":"translateY(110%)"});
		});
		//支付跳转 +
		$('#wxpay').attr("href","wxPay.html?reportId=" +myreportId+ "&userId=" +userId+ "&packageId=" +packageId+"&name=" +name+ "&price=" +price + '&openId=' + myopenId);
		$('#WordPay').attr("href","wordPay.html?reportId=" +myreportId+ "&userId=" +userId+ "&packageId=" +packageId + '&openId=' + myopenId);
		$('#kaPay').attr("href","selectTycard.html?reportId=" +myreportId+ "&userId=" +userId+ "&packageId=" +packageId + '&openId=' + myopenId);
		
	}else{
		alert(indexData.msg);
	}
	
},
    error : function(obj,msg){
    	console.log(obj  + msg);
    }
});
</script>

</body>
</html>
