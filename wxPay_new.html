<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width" name="viewport" />
<meta content="yes" name="apple-mobile-web-app-capable" />
<meta content="black" name="apple-mobile-web-app-status-bar-style" /> 
<meta content="telephone=no" name="format-detection" />
<title>支付</title>
<link rel="stylesheet" type="text/css" href="css/basic.css" />
<link rel="stylesheet" type="text/css" href="css/style.css" />
</head>
<body>
<div class="my_view bck-col-f4" id="appVUE">
	<header class="header">
		<a class="b-arr fl" href="javascript:history.go(-1);"></a>
		<a class="t-right fr" href="#"></a>
		<p class="t-cen txt1"><span>{{payTypeName}}</span></p>
	</header>
	<div class="d-wxpay">
		<div class="wxpay">
			<div class="dtit"><i class=""></i><span class="">订单已提交成功，请您尽快付款</span></div>
			<p class="p1"><span>订单名称：</span><font>{{name}}</font></p>
			<p class="p1"><span>订单金额：</span><font>{{price}}</font>元套餐</p>
		</div>
		<p class="xiaoji"><span><em id="xgj">共计</em>：￥</span><font>{{price}}</font></p>
	</div>
	
	<div class="d-wxpay" id="usecoupon" style="display: none;">
		<p class="coutit">使用优惠券</p>
		<div class="wxpay">
			<p class="coupon on"><i class="check"></i><span>使用优惠券</span><em id="discount" class="fr">-￥0</em></p>
		</div>
		<p class="xiaoji" style="line-height: 1rem;"><span>共计：￥</span><font id="subprice">{{price}}</font></p>
	</div>
	<p style="padding: 0 .3rem; font-size: .24rem;">注：请您在48小时内付款，超出48小时后此报告将无法查看</p>
	
	<div class="subpay"><button class="btn_pay" id="goWxPay">支付</button></div>
</div>

<!--一网通请求-->
<form action="" method="post" id="ywt">
    <input id="ywtVal" type="hidden" name="jsonRequestData" value='' />
</form>

<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/base.js"></script>
<script type="text/javascript" src="js/vue.min.js"></script>
<script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script type="text/javascript">
(function (doc, win) {
    var docEl = doc.documentElement,
        resizeEvt = 'orientationchange' in window ? 'orientationchange' : 'resize',
        recalc = function () {
            var clientWidth = docEl.clientWidth;
            if (!clientWidth) return;
            if(clientWidth>=750){
                docEl.style.fontSize = '100px';
            }else{
                docEl.style.fontSize = 100 * (clientWidth / 750) + 'px';
            }
        };

    if (!doc.addEventListener) return;
    win.addEventListener(resizeEvt, recalc, false);
    doc.addEventListener('DOMContentLoaded', recalc, false);
})(document, window);
</script>
<script>
//截取URL 获取
function GetQueryString(name){
     var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
     var r = window.location.search.substr(1).match(reg);
     if(r!=null)return  unescape(r[2]); return null;
};
var indexUrl = window.location.href;
var myreportId=GetQueryString("reportId");
var mypackageId=GetQueryString("packageId");
var myuserId=GetQueryString("userId");
var myopenId=GetQueryString("openId");
var orderNum=GetQueryString("orderNum");
var payChannelId=GetQueryString("payChannelId");
var payChannelType=GetQueryString("payChannelType");  //1微信 7招行一网通
if(payChannelType == 1){
	var payTypeName = '微信支付'
}else if(payChannelType == 7){
	var payTypeName = '一网通支付'
}else{
	var payTypeName = '支付'
};

var tp=GetQueryString("tp");  //判断kj201
var edition=GetQueryString("edition"); //判断用哪一版页面显示首页
if(edition==null){
	edition = '';
};
var myurl = window.location;
var useurl = decodeURI(myurl);
var start =useurl.indexOf('name=');
var stop =useurl.indexOf('&',start);
var myname = useurl.substring(start+5,stop);
var myprice=GetQueryString("price");
var myApp = new Vue({
  el: '#appVUE',
  data: {
  	name: myname, 
    price: myprice,
    payTypeName: payTypeName
    
  }
});
var voucherId = '';
//点击支付
$(document).on("click","#goWxPay",function(){
	//alert('go');
	var truePrice = $('#subprice').text();
	$(this).attr("disabled",true);  //新加防呆
		$.ajax({
	    url:channel + "/pay/v1/channel/payOrder",
	    type : "POST",
		dataType : 'json',
		data : {
		    attach : myopenId, 
		    orderNum : orderNum,
		    payChannelId : payChannelId,
		    payPrice : truePrice,
		    userId : myuserId,
		},
	    success : function(result) {
	    	if(payChannelType == 1){ //weixin
	    		if(result.code == 0) {
		            WeixinJSBridge.invoke('getBrandWCPayRequest',{  
		                "appId" : result.result.appId,              //公众号名称，由商户传入  
		                "timeStamp": result.result.timeStamp,       //时间戳，自 1970 年以来的秒数  
		                "nonceStr" : result.result.nonceStr,        //随机串  
		                "package" : result.result.package,          //商品包信息 
		                "signType" : result.result.signType,       //微信签名方式
		                "paySign" : result.result.sign            //微信签名  
		                },function(res){
		                	//debugger;
		                    if(res.err_msg == "get_brand_wcpay_request:ok" ) { //支付成功
		                        // 支付成功回调
		                        $.ajax({
		                        	//async: false,
					                url:dataUrl + "/api/v1/reportWxPay/successCallback",
					              	type : "POST",
					              	dataType : 'json',
									data : {
									    orderNum : orderNum, 
									    voucherId: voucherId
									},
					                success : function(payreuslt) {
					                	if(tp == 201){
					                		window.location.href=bit_testHealthUrl + "/index.html?reportId="+myreportId + '&openId=' + myopenId;
					                	}else{
					                		if(edition == 100){
					                			window.location.href="fund/index.html?reportId="+myreportId + '&openId=' + myopenId;
					                		}else{
					                			window.location.href="index"+edition+".html?reportId="+myreportId + '&openId=' + myopenId;
					                		}
					                	}
					                },
					                error:function(){alert('successCallback error');}
		                       });
		                    }else if (res.err_msg == "get_brand_wcpay_request:cancel") {
								alert("支付取消");
								$('#goWxPay').attr("disabled",false);  //新加防呆
							}else if (res.err_msg == "get_brand_wcpay_request:fail") {
								alert("支付失败："+res.err_desc);
								$('.wxpay .dtit i').addClass('fail');
								$('.wxpay .dtit span').html('支付失败');
								$('#goWxPay').attr("disabled",false);  //新加防呆
							}
		                }
		            ); 
		        }else{
		            alert(result.msg);
		            $('#goWxPay').attr("disabled",false);  //新加防呆
		        }
	    	///////////
	    	}else if(payChannelType == 7){ //yiwangtong
	    		if(result.code ==0){
	    			//一网通支付操作
	    			var form = document.getElementById('ywt');
	    			form.action = result.url;
	    			var _val = result.result;
	    			$('#ywtVal').val(_val);
	    			form.submit();
	    		}
	    	//////////
	    	}
	    	
		    	
	    }
	});
});

//判断优惠卷是否可用,返回有效期最短的优惠券
$.ajax({
	url : couponData + "/v1/use/coupon/isUsableByCustomerIdAndNeId",
    type : "POST",
	dataType : 'json',
	data : {
	    inspectCode : myreportId, //报告ID
	    customerId : myuserId
	},
	success: function(data){
		//alert('yhq');
		var discount=0;
		if(data.data == null || data.data == ''){
			$('#usecoupon').css("display","none");
		}else{
			$('#xgj').text('小计');
			$('#usecoupon').css("display","block");
			if(data.data.discountType == 1){
				discount = data.data.discountNum;
			}else if(data.data.discountType == 2){
				discount = myprice-(myprice*data.data.discountNum)
			};
			voucherId = data.data.voucherId;
			$('#discount').text('￥-'+ discount);
			$('#subprice').text((myprice-discount).toFixed(2));
		};
	},
	error: function(){
		console.log('查询可用优惠券出错');
	}
});

//再次进去页面判断调取接口判断报告是否是已经支付
$.ajax({
	url : dataUrl + "/api/v1/reportWxPay/findPackage",
    type : "POST",
	dataType : 'json',
	data : {
	    reportId : myreportId, 
	    openId : myopenId
	},
	success: function(data){
		if(data.code == 200){
			if(edition == 100){
    			window.location.href="fund/index.html?reportId="+myreportId + '&openId=' + myopenId;
    		}else{
    			window.location.href="index"+edition+".html?reportId="+myreportId + '&openId=' + myopenId;
    		}
		}
	}
});

</script>


</body>
</html>
